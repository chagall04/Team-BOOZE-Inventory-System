// jenkinsfile
pipeline {
    agent any // Run on any Jenkins node

    environment {
        // MUST MATCH the SonarQube Server name from Jenkins > System
        SONAR_SERVER = 'SonarCloud' 
    }

    // Tools defined in Jenkins > Tools
    tools {
        // MUST MATCH JDK name from Jenkins > Tools
        jdk 'jdk-21'     
        // MUST MATCH NodeJS name from Jenkins > Tools
        nodejs 'node-22' 
    }

    stages {
        stage('1. Checkout Code') {
            steps {
                echo 'Code checkout completed by Jenkins SCM step.'
            }
        }
        
        stage('2. Install Dependencies') {
            steps {
                // --- THIS LINE IS CHANGED ---
                // Use 'python -m pip' instead of just 'pip'
                bat 'python -m pip install -r requirements.txt'
            }
        }
        
        stage('3. Run Linter (Pylint)') {
            steps {
                // --- THIS LINE IS CHANGED ---
                // Use 'python -m pylint' instead of just 'pylint'
                bat 'python -m pylint src/ > pylint-report.txt || exit 0'
            }
        }
        
        stage('4. Run Unit Tests & Coverage') {
            steps {
                // --- THIS LINE IS CHANGED ---
                // Use 'python -m pytest' instead of just 'pytest'
                bat 'python -m pytest --cov=src --cov-report=xml'
            }
        }
        
        stage('5. SonarCloud Analysis') {
            steps {
                withSonarQubeEnv(SONAR_SERVER) {
                    script {
                        def scannerHome = tool 'SonarScanner-Latest' 
                        bat(script: """
                            "${scannerHome}/bin/sonar-scanner.bat" ^
                              -Dsonar.projectKey=chagall04_Team-BOOZE-Inventory-System ^
                              -Dsonar.organization=chagall04 ^
                              -Dsonar.sources=src ^
                              -Dsonar.host.url=https://sonarcloud.io ^
                              -Dsonar.login=%SONAR_TOKEN% ^
                              -Dsonar.python.coverage.reportPaths=coverage.xml ^
                              -Dsonar.python.pylint.reportPaths=pylint-report.txt
                        """, returnStdout: true) 
                    }
                }
            }
        }
    }
    
    post {
        always {
            cleanWs()
            echo 'Pipeline finished.'
        }
    }
}
